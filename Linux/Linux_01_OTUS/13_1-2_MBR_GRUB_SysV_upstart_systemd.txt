*************************************************************************
******************* Системы инициализации *******************************
*************************************************************************

*************** MBR, GRUB, Kernel Загрузка Linux ************************
MBR - Master Boot Record Нлавная загрузочная запись
Состоит из 512 байт (старая, сейчас GPT)
Содержит код загрузчика (описывает sda, sda1, sda2 и т.д)
Необходим для загрузки ОС

GRUB - GRand Unified Bootloader
Позволяет пользователю иметь несколько установленных ОС
Умеет по цепочке передавать управление другому загрузчику (пример Windows)
Популярный загрузчик

Kernel - ядро Linux
Ядро должно содержать драйвер диска для каталога / (корневого каталога)
Initial RAM Disk - предоставляет для ядра драйвера для дальнейшего монтирования диска (он монтируется как кусок оперативной памяти RAM, а потом уже ядро сможет монтировать диск)
После этого начнется процес инициализации

******************* Система инициализации *******************************
Стартует после загрузки ядра
Она начинается с первого процесса (init/systemd)
Далее определяет порядок запуска служб и программ

три системы инициализации
1. SysV - самая старая. Основана на стартовых скриптах расположенных в определенных каталогах
2. Upstart - создана для упращения написания стартовых скриптов. Все стартовые службы имели одного родителя. Она полностью совместима с SysV
3. systemd - современная система. Стандарт по умолчанию для современных unix систем. Взяла самое лучшее от upstart и добавила паралельность запуска. Если служба не запустилась systemd будет продолжать запускать ее дальше.

Скрипты инициализации системы SysV находятся:
└─$ ls -l /etc/init.d/
total 300
-rwxr-xr-x 1 root root 8139 Apr 13  2023 apache2
-rwxr-xr-x 1 root root 2489 Jul  5  2022 apache-htcacheclean
-rwxr-xr-x 1 root root 3740 Feb 14  2023 apparmor
-rwxr-xr-x 1 root root 1614 Feb 19  2023 atftpd
...
-rwxr-xr-x 1 root root 1871 Oct 22  2017 xl2tpd

Все файлы это скрипты (sudo cat /etc/init.d/networking или sudo vi /etc/init.d/cat /etc/init.d/networking)
Пример просмотра:
grep -v ^# /etc/init.d/networking | grep -v ^$ 
# ключи grep -v ^# - убрать все строки начинающиеся с # и -v ^$ убрать все пустые строки


grep -v ^# /etc/init.d/networking | grep -v ^$ | wc -l
158 строк

Система инциализации upstart
└─$ type service 
service is /usr/sbin/service

Есть каталоги rc
└─$  ls -l /etc/rc
Completing file
rc0.d/  rc1.d/  rc2.d/  rc3.d/  rc4.d/  rc5.d/  rc6.d/  rcS.d/
# Пример каталога rc1.d
└─$  ls -l /etc/rc1.d 
total 0
lrwxrwxrwx 1 root root 17 Jul 12  2023 K01apache2 -> ../init.d/apache2
lrwxrwxrwx 1 root root 29 Jul 12  2023 K01apache-htcacheclean -> ../init.d/apache-htcacheclean
lrwxrwxrwx 1 root root 16 Jul 12  2023 K01atftpd -> ../init.d/atftpd
lrwxrwxrwx 1 root root 19 Jul 12  2023 K01bluetooth -> ../init.d/bluetooth
lrwxrwxrwx 1 root root 24 Jul 12  2023 K01cgroupfs-mount -> ../init.d/cgroupfs-mount
...
lrwxrwxrwx 1 root root 16 Jul 12  2023 K01xl2tpd -> ../init.d/xl2tpd

каталоги rc показывают когда и где будут стартовать те или иные  службы     

Система инициализации systemd
Находится в каталоге /lib/systemd/system
# Пример
└─$ ls -l /lib/systemd/system
total 1608
-rw-r--r-- 1 root root  1965 Jan 31 14:30  accounts-daemon.service
-rw-r--r-- 1 root root   438 Oct 19 13:52  apache2.service
-rw-r--r-- 1 root root   491 Aug 26  2023  apache2@.service
...
-rw-r--r-- 1 root root   482 Dec 25 12:47  wpa_supplicant-wired@.service
lrwxrwxrwx 1 root root     9 Feb 27 20:43  x11-common.service -> /dev/null

Здесь находятся файлы отвечающие за старт тех или иных служб
Пример файла:
└─$ cat /lib/systemd/system/umount.target
#  SPDX-License-Identifier: LGPL-2.1-or-later
#
#  This file is part of systemd.
#
#  systemd is free software; you can redistribute it and/or modify it
#  under the terms of the GNU Lesser General Public License as published by
#  the Free Software Foundation; either version 2.1 of the License, or
#  (at your option) any later version.

[Unit]
Description=Unmount All Filesystems
Documentation=man:systemd.special(7)
DefaultDependencies=no
RefuseManualStart=yes

Здесь все проще, чем в предыдущих системах инициализации

В каталоге /run/systemd/generator.late/ находятся сервисы которые были автоматически сгенерированы после того как был прочитан каталог /etc/init.d
# Пример сгенерированного файла
└─$ cat /run/systemd/generator.late/dns2tcp.service
# Automatically generated by systemd-sysv-generator

[Unit]
Documentation=man:systemd-sysv-generator(8)
SourcePath=/etc/init.d/dns2tcp
Description=LSB: dns2tcp server init script
After=network-online.target
After=remote-fs.target
Wants=network-online.target

[Service]
Type=forking
Restart=no
TimeoutSec=5min
IgnoreSIGPIPE=no
KillMode=process
GuessMainPID=no
RemainAfterExit=yes
SuccessExitStatus=5 6
ExecStart=/etc/init.d/dns2tcp start
ExecStop=/etc/init.d/dns2tcp stop
ExecReload=/etc/init.d/dns2tcp reload

Интересно:
ExecStart=/etc/init.d/dns2tcp start  - старт службы
ExecStop=/etc/init.d/dns2tcp stop  - остановка службы

и мы можем его запустить сами с разными параметрами
запустив его без параметров мы получим подсказку о параметрах запуска










